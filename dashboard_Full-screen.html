<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Building Monitor Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#05060a;
  --panel:#0b1020;
  --panel2:#0a0f1c;
  --border: rgba(120, 140, 255, 0.18);
  --text:#e6eaff;
  --muted:#9aa4c7;

  --cyan:#2ef2ff;
  --purple:#8b5cf6;
  --green:#00e676;
  --red:#ff3b3b;

  --shadow: 0 0 24px rgba(46, 242, 255, 0.10);
  --radius:16px;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

*{ box-sizing:border-box; }

html, body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:var(--font);
}

/* ====== FULL SCREEN LAYOUT ====== */
.app{
  height: 100vh;
  width: 100vw;
  padding: 14px;
  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 12px;
}

/* ====== LEFT COLUMN ====== */
.leftCol{
  display:flex;
  flex-direction:column;
  gap:12px;
  min-width: 360px;
}

/* ====== RIGHT COLUMN ====== */
.rightCol{
  display:flex;
  flex-direction:column;
  gap:12px;
  min-width: 0; /* important for charts */
}

/* ====== HEADER ====== */
.header{
  background: linear-gradient(135deg, rgba(46,242,255,0.08), rgba(139,92,246,0.06));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: var(--shadow);
}

.titleRow{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
}

h2{
  margin:0;
  font-size: 14px;
  letter-spacing: 0.6px;
  font-weight: 800;
  text-transform: uppercase;
}

.sub{
  margin-top: 4px;
  font-size: 11px;
  color: var(--muted);
}

.badge{
  font-size: 10px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(46,242,255,0.22);
  background: rgba(46,242,255,0.06);
  color: var(--cyan);
  white-space: nowrap;
}

/* ====== KPI ====== */
.kpiHeader{
  margin-top: 10px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

.kpiValue{
  font-size: 15px;
  font-weight: 900;
  letter-spacing: 0.2px;
  text-shadow: 0 0 14px rgba(46,242,255,0.08);
}

.kpiRef{
  font-size: 11px;
  color: var(--muted);
}

.kpiValue.ok { color: var(--green); }
.kpiValue.bad { color: var(--red); }

/* ====== SECCIONES ====== */
.panel{
  background: linear-gradient(180deg, rgba(10,15,28,0.98), rgba(8,10,18,0.98));
  border: 1px solid rgba(120, 140, 255, 0.16);
  border-radius: var(--radius);
  padding: 12px;
  box-shadow: 0 0 22px rgba(0,0,0,0.45);
}

/* ====== CONTROLES ====== */
.controls{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

.controls2{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
}

label{
  font-size:10px;
  color: var(--muted);
  display:block;
  margin-bottom:6px;
  text-transform: uppercase;
  letter-spacing:0.3px;
}

.dateField{
  position: relative;
}

.dateField input[type="date"]{
  width:100%;
  padding:10px 38px 10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(46,242,255,0.18);
  background: rgba(3,6,12,0.65);
  color: var(--text);
  font-size: 12px;
  outline:none;
}

.dateField input[type="date"]:focus{
  border-color: rgba(46,242,255,0.45);
  box-shadow: 0 0 0 3px rgba(46,242,255,0.10);
}

.dateIconBtn{
  position:absolute;
  top:50%;
  right:10px;
  transform: translateY(-50%);
  width: 26px;
  height: 26px;
  border-radius: 10px;
  border: 1px solid rgba(46,242,255,0.18);
  background: rgba(46,242,255,0.06);
  color: var(--cyan);
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size: 14px;
}

select{
  width:100%;
  padding:10px 10px;
  border-radius: 14px;
  border: 1px solid rgba(46,242,255,0.18);
  background: rgba(3,6,12,0.65);
  color: var(--text);
  font-size: 12px;
  outline:none;
}

select:focus{
  border-color: rgba(46,242,255,0.45);
  box-shadow: 0 0 0 3px rgba(46,242,255,0.10);
}

/* ====== M√âTRICAS ====== */
#metrics{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:8px;
}

.metric{
  border: 1px solid rgba(46,242,255,0.12);
  border-radius: 14px;
  padding: 10px;
  background: rgba(3,6,12,0.55);
}

.metric b{
  display:block;
  font-size: 10px;
  color: var(--muted);
  font-weight: 700;
  margin-bottom: 6px;
  letter-spacing: 0.2px;
  text-transform: uppercase;
}

.metric span{
  font-size: 14px;
  font-weight: 900;
}

.metric small{
  display:block;
  margin-top: 6px;
  color: var(--muted);
  font-size: 10px;
}

/* ====== CHART ====== */
.canvasWrap{
  flex: 1;
  min-height: 0;
  display:flex;
  flex-direction:column;
  gap:10px;
}

.chartTitle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  color: var(--muted);
  font-size: 11px;
}

.chartBox{
  flex: 1;
  min-height: 0;
  position: relative;
}

/* üî• IMPORTANTE:
   Reservamos espacio real abajo para el eje X
   y evitamos que quede cortado por el viewport */
canvas{
  position:absolute;
  inset:0;
  width:100% !important;
  height:100% !important;

  background: rgba(3,6,12,0.55);
  border: 1px solid rgba(46,242,255,0.12);
  border-radius: var(--radius);
  padding: 14px 14px 26px 14px;
}

.exportBtn{
  padding: 6px 10px;
  font-size: 10px;
  border-radius: 999px;
  cursor: pointer;
  border: 1px solid rgba(46,242,255,0.22);
  background: rgba(46,242,255,0.06);
  color: var(--cyan);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.exportBtn:hover{
  border-color: rgba(46,242,255,0.45);
  box-shadow: 0 0 0 3px rgba(46,242,255,0.10);
}

@media (max-width: 980px){
  .app{
    grid-template-columns: 1fr;
  }
  #metrics{
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>

<body>

<div class="app">

  <!-- LEFT -->
  <div class="leftCol">

    <!-- HEADER -->
    <div class="header">
      <div class="titleRow">
        <div>
          <h2>Building Monitor</h2>
          <div class="sub">Live telemetry dashboard</div>
        </div>
        <div class="badge">LIVE</div>
      </div>

      <div class="kpiHeader">
        <div id="energiaHoy" class="kpiValue">Energ√≠a total consumida HOY: -- kWh</div>
        <div id="energiaRef" class="kpiRef">Referencia (10 d√≠as laborables): -- kWh</div>
        <div id="ultimaAct" class="kpiRef">√öltima actualizaci√≥n: --</div>
      </div>
    </div>

    <!-- CONTROLES -->
    <div class="panel">
      <div class="controls">
        <div>
          <label>Sensor</label>
          <select id="sensorSelect"></select>
        </div>

        <div>
          <label>Resoluci√≥n</label>
          <select id="resolutionSelect">
            <option value="15m">15 min</option>
            <option value="1h">Hora</option>
            <option value="1d">D√≠a</option>
          </select>
        </div>
      </div>

      <div class="controls2">
        <div>
          <label>CONSULTA FECHA INICIO</label>
          <div class="dateField">
            <input type="date" id="dateStart">
            <button class="dateIconBtn" type="button" onclick="openCalendar('dateStart')" title="Abrir calendario">üìÖ</button>
          </div>
        </div>

        <div>
          <label>CONSULTA FECHA FINAL</label>
          <div class="dateField">
            <input type="date" id="dateEnd">
            <button class="dateIconBtn" type="button" onclick="openCalendar('dateEnd')" title="Abrir calendario">üìÖ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- M√âTRICAS -->
    <div class="panel">
      <div id="metrics"></div>
    </div>

  </div>

  <!-- RIGHT -->
  <div class="rightCol">

    <!-- CHART -->
    <div class="panel canvasWrap">
      <div class="chartTitle">
        <div id="chartLabel">Serie temporal</div>

        <div style="display:flex; gap:8px; align-items:center;">
          <button class="exportBtn" onclick="exportData('csv')">CSV</button>
          <button class="exportBtn" onclick="exportData('json')">JSON</button>
          <div style="color: var(--cyan);" id="liveDot">‚óè LIVE</div>
        </div>
      </div>

      <div class="chartBox">
        <canvas id="chart"></canvas>
      </div>
    </div>

  </div>

</div>

<script>
let chart = null;
let currentSensorData = null;
let currentIndex = null;

const INDEX_URL = "indice_sensores.json";
const DATA_DIR = "datos_sensores";

// Auto-refresh cada 15 minutos
const AUTO_REFRESH_MS = 15 * 60 * 1000;

// Sensor KPI fijo (energ√≠a total consumida)
const KPI_SENSOR_ID = "0190_MV_C1_ASB_ACTIVEE";

/* ==============================
   ICONO CALENDARIO
================================ */
function openCalendar(inputId) {
  const el = document.getElementById(inputId);
  if (!el) return;
  if (typeof el.showPicker === "function") el.showPicker();
  else { el.focus(); el.click(); }
}

/* ==============================
   FECHAS
================================ */
function toISODateLocal(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function startOfDay(dateObj) {
  const d = new Date(dateObj);
  d.setHours(0,0,0,0);
  return d;
}

function endOfDay(dateObj) {
  const d = new Date(dateObj);
  d.setHours(23,59,59,999);
  return d;
}

function isWeekday(dateObj){
  const day = dateObj.getDay(); // 0 domingo, 6 s√°bado
  return day >= 1 && day <= 5;
}

function filterByDates(labels, values, dateStart, dateEnd) {
  const from = startOfDay(new Date(dateStart));
  const to = endOfDay(new Date(dateEnd));

  const outLabels = [];
  const outValues = [];

  labels.forEach((l, i) => {
    const t = new Date(l);
    if (t >= from && t <= to) {
      outLabels.push(l);
      outValues.push(values[i]);
    }
  });

  return { outLabels, outValues };
}

/* ==============================
   AGREGACI√ìN 15m -> hora / d√≠a
================================ */
function bucketKey(dateObj, resolution) {
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth()+1).padStart(2, "0");
  const d = String(dateObj.getDate()).padStart(2, "0");
  const hh = String(dateObj.getHours()).padStart(2, "0");

  if (resolution === "1d") return `${y}-${m}-${d}`;
  if (resolution === "1h") return `${y}-${m}-${d} ${hh}:00`;
  return dateObj.toISOString();
}

function aggregateSeries(labels, values, resolution, tipo) {
  if (resolution === "15m") return { labels, values };

  const map = new Map();

  labels.forEach((l, i) => {
    const t = new Date(l);
    const key = bucketKey(t, resolution);

    if (!map.has(key)) map.set(key, { sum: 0, count: 0 });
    const obj = map.get(key);

    obj.sum += values[i];
    obj.count += 1;
  });

  const outLabels = [];
  const outValues = [];

  for (const [key, obj] of map.entries()) {
    outLabels.push(key);
    if (tipo === "consumo_intervalo") outValues.push(obj.sum);
    else outValues.push(obj.sum / obj.count);
  }

  return { labels: outLabels, values: outValues };
}

/* ==============================
   M√âTRICAS (SIN MIN/MAX)
================================ */
function sumEnergyToday(labels, values) {
  if (!labels.length) return 0;

  const lastTs = new Date(labels[labels.length - 1]);
  const dayStart = startOfDay(lastTs);

  let sum = 0;
  for (let i = 0; i < labels.length; i++) {
    const t = new Date(labels[i]);
    if (t >= dayStart && t <= lastTs) sum += values[i];
  }
  return sum;
}

function dailyTotals(labels, values){
  const map = new Map();

  for(let i=0;i<labels.length;i++){
    const t = new Date(labels[i]);
    const dayKey = t.toISOString().slice(0,10);

    if(!map.has(dayKey)) map.set(dayKey, 0);
    map.set(dayKey, map.get(dayKey) + values[i]);
  }
  return map;
}

function calcMetrics(rawLabels, rawValues, tipo) {
  if (!rawValues.length) return { actual:null, media:null, suma:null };

  const sumaTotal = rawValues.reduce((a, b) => a + b, 0);

  let actual, media, suma;

  if (tipo === "consumo_intervalo") {
    actual = sumEnergyToday(rawLabels, rawValues);

    const totals = dailyTotals(rawLabels, rawValues);
    const lastDayKey = new Date(rawLabels[rawLabels.length - 1]).toISOString().slice(0,10);

    let sumDays = 0;
    let countDays = 0;

    for(const [dayKey, total] of totals.entries()){
      if(dayKey === lastDayKey) continue;
      sumDays += total;
      countDays += 1;
    }

    media = countDays ? (sumDays / countDays) : null;
    suma  = sumaTotal;
  } else {
    actual = rawValues[rawValues.length - 1];
    media  = sumaTotal / rawValues.length;
    suma   = null;
  }

  return { actual, media, suma };
}

function renderMetrics(m, unidad, tipo) {
  const fmt = v => (v === null || v === undefined) ? "--" : v.toFixed(2);

  const labelActual = (tipo === "consumo_intervalo") ? "Actual (hoy)" : "Actual";
  const labelMedia = (tipo === "consumo_intervalo") ? "Media diaria" : "Media";

  document.getElementById("metrics").innerHTML = `
    <div class="metric"><b>${labelActual}</b><span>${fmt(m.actual)}</span><small>${m.actual != null ? unidad : ""}</small></div>
    <div class="metric"><b>${labelMedia}</b><span>${fmt(m.media)}</span><small>${m.media != null ? unidad : ""}</small></div>
    <div class="metric"><b>Suma</b><span>${fmt(m.suma)}</span><small>${m.suma != null ? unidad : ""}</small></div>
  `;
}

/* ==============================
   GR√ÅFICA (arreglo eje X cortado)
================================ */
function drawChart(labels, values, titulo) {
  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();

  document.getElementById("chartLabel").textContent = titulo;

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: titulo,
          data: values,
          borderWidth: 2,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: "index" },
      layout: {
        padding: { bottom: 22 }
      },
      plugins: {
        legend: { labels: { color: "#9aa4c7" } }
      },
      scales: {
        x: {
          ticks: { color: "#9aa4c7", maxRotation: 0 },
          grid: { color: "rgba(120,140,255,0.08)" }
        },
        y: {
          ticks: { color: "#9aa4c7" },
          grid: { color: "rgba(120,140,255,0.08)" }
        }
      }
    }
  });
}

/* ==============================
   EXPORT CSV / JSON
================================ */
function downloadFile(filename, content, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

function getCurrentFilteredData() {
  if (!currentSensorData) return null;

  const dateStart = document.getElementById("dateStart").value;
  const dateEnd = document.getElementById("dateEnd").value;
  const resolution = document.getElementById("resolutionSelect").value;

  const filtered = filterByDates(
    currentSensorData.labels,
    currentSensorData.values,
    dateStart,
    dateEnd
  );

  const aggregated = aggregateSeries(
    filtered.outLabels,
    filtered.outValues,
    resolution,
    currentSensorData.tipo_dato
  );

  return {
    sensor_id: currentSensorData.sensor_id,
    descripcion: currentSensorData.descripcion,
    unidad: currentSensorData.unidad,
    tipo_dato: currentSensorData.tipo_dato,
    resolution,
    dateStart,
    dateEnd,
    points: aggregated.labels.map((l, i) => ({
      timestamp: l,
      value: aggregated.values[i]
    }))
  };
}

function exportData(format) {
  const data = getCurrentFilteredData();
  if (!data || !data.points.length) {
    alert("No hay datos para exportar en el rango seleccionado.");
    return;
  }

  const safeName = data.sensor_id.replace(/[^a-zA-Z0-9_-]/g, "_");
  const filenameBase = `${safeName}_${data.dateStart}_${data.dateEnd}_${data.resolution}`;

  if (format === "json") {
    const jsonText = JSON.stringify(data, null, 2);
    downloadFile(`${filenameBase}.json`, jsonText, "application/json");
    return;
  }

  const header = ["timestamp","value","unidad","sensor_id","descripcion"].join(",");
  const rows = data.points.map(p => {
    const ts = `"${p.timestamp}"`;
    const val = (p.value ?? "").toString();
    const unidad = `"${data.unidad}"`;
    const id = `"${data.sensor_id}"`;
    const desc = `"${data.descripcion.replace(/"/g, '""')}"`;
    return [ts, val, unidad, id, desc].join(",");
  });

  const csvText = [header, ...rows].join("\n");
  downloadFile(`${filenameBase}.csv`, csvText, "text/csv");
}

/* ==============================
   FETCH REAL
================================ */
async function fetchJSON(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error(`HTTP ${r.status} -> ${url}`);
  return await r.json();
}

async function loadIndex() {
  currentIndex = await fetchJSON(`${INDEX_URL}?t=${Date.now()}`);
}

async function loadSensorById(sensorId) {
  if (!currentIndex?.sensores?.[sensorId]) {
    throw new Error(`Sensor no encontrado en indice: ${sensorId}`);
  }

  const file = currentIndex.sensores[sensorId].archivo;
  const url = `${DATA_DIR}/${file}?t=${Date.now()}`;

  return await fetchJSON(url);
}

/* ==============================
   KPI: Energ√≠a total consumida HOY
================================ */
function computeReference10Workdays(labels, values){
  const totals = dailyTotals(labels, values);
  const days = Array.from(totals.keys()).sort((a,b)=> b.localeCompare(a));
  const lastDayKey = new Date(labels[labels.length - 1]).toISOString().slice(0,10);

  let used = 0;
  let sum = 0;

  for(const dayKey of days){
    if(dayKey === lastDayKey) continue;
    const dayDate = new Date(dayKey + "T00:00:00");
    if(!isWeekday(dayDate)) continue;

    sum += totals.get(dayKey);
    used += 1;

    if(used >= 10) break;
  }

  return used ? (sum / used) : null;
}

async function updateKPIEnergia(){
  try{
    const kpiData = await loadSensorById(KPI_SENSOR_ID);

    if(!kpiData?.labels?.length){
      return;
    }

    const hoy = sumEnergyToday(kpiData.labels, kpiData.values);
    const ref = computeReference10Workdays(kpiData.labels, kpiData.values);

    const energiaEl = document.getElementById("energiaHoy");
    const refEl = document.getElementById("energiaRef");
    const ultimaEl = document.getElementById("ultimaAct");

    energiaEl.textContent = `Energ√≠a total consumida HOY: ${hoy.toFixed(2)} kWh`;

    if(ref === null){
      refEl.textContent = `Referencia (10 d√≠as laborables): -- kWh`;
      energiaEl.classList.remove("ok","bad");
      energiaEl.classList.add("ok");
    }else{
      refEl.textContent = `Referencia (10 d√≠as laborables): ${ref.toFixed(2)} kWh`;

      energiaEl.classList.remove("ok","bad");
      if(hoy > ref) energiaEl.classList.add("bad");
      else energiaEl.classList.add("ok");
    }

    const last = new Date(kpiData.labels[kpiData.labels.length - 1]);
    ultimaEl.textContent = `√öltima actualizaci√≥n: ${last.toLocaleString("es-ES")}`;

  }catch(e){
    console.warn("KPI energ√≠a error:", e);
  }
}

/* ==============================
   UI
================================ */
function setDefaultLast2Days() {
  const now = new Date();
  const end = toISODateLocal(now);
  const start = new Date(now.getTime() - 1 * 86400000);

  document.getElementById("dateStart").value = toISODateLocal(start);
  document.getElementById("dateEnd").value = end;
}

function redraw() {
  if (!currentSensorData) return;

  const dateStart = document.getElementById("dateStart").value;
  const dateEnd = document.getElementById("dateEnd").value;
  const resolution = document.getElementById("resolutionSelect").value;

  const filtered = filterByDates(
    currentSensorData.labels,
    currentSensorData.values,
    dateStart,
    dateEnd
  );

  const aggregated = aggregateSeries(
    filtered.outLabels,
    filtered.outValues,
    resolution,
    currentSensorData.tipo_dato
  );

  if (!aggregated.values.length) {
    renderMetrics({ actual:null, media:null, suma:null }, currentSensorData.unidad, currentSensorData.tipo_dato);
    return;
  }

  drawChart(aggregated.labels, aggregated.values, currentSensorData.descripcion);

  const m = calcMetrics(filtered.outLabels, filtered.outValues, currentSensorData.tipo_dato);
  renderMetrics(m, currentSensorData.unidad, currentSensorData.tipo_dato);
}

async function initUI() {
  await loadIndex();

  const select = document.getElementById("sensorSelect");
  select.innerHTML = "";

  const entries = Object.entries(currentIndex.sensores || {});
  entries.forEach(([id, s]) => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = s.descripcion || id;
    select.appendChild(opt);
  });

  setDefaultLast2Days();
  document.getElementById("resolutionSelect").value = "15m";

  select.onchange = async () => {
    currentSensorData = await loadSensorById(select.value);
    redraw();
  };

  document.getElementById("dateStart").onchange = redraw;
  document.getElementById("dateEnd").onchange = redraw;
  document.getElementById("resolutionSelect").onchange = redraw;

  if (select.value) {
    currentSensorData = await loadSensorById(select.value);
    redraw();
  }

  await updateKPIEnergia();
}

async function autoRefreshLoop() {
  try {
    const currentSelected = document.getElementById("sensorSelect").value;

    await loadIndex();

    if (currentSelected) {
      currentSensorData = await loadSensorById(currentSelected);
      redraw();
    }

    await updateKPIEnergia();

    const dot = document.getElementById("liveDot");
    dot.style.opacity = "0.35";
    setTimeout(() => dot.style.opacity = "1", 150);

  } catch (e) {
    console.warn("Auto refresh error:", e);
  }
}

initUI();
setInterval(autoRefreshLoop, AUTO_REFRESH_MS);
</script>

</body>
</html>
