<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Building Monitor</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* === ESTÉTICA BASE (NO TOCAR) === */
:root{
  --bg:#05060a;
  --panel:#0b1020;
  --panel2:#0a0f1c;
  --border: rgba(120, 140, 255, 0.18);
  --text:#e6eaff;
  --muted:#9aa4c7;

  --cyan:#2ef2ff;
  --purple:#8b5cf6;
  --green:#00e676;
  --red:#ff3b3b;
  --yellow:#ffd166;

  --radius:16px;
  --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

*{ box-sizing:border-box; }

html, body{
  margin:0;
  height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:var(--font);
  overflow:hidden;
}

/* === LAYOUT === */
.app{
  display:grid;
  grid-template-rows: auto 1fr;
  height:100vh;
  gap:12px;
  padding:12px;
}

/* === HEADER === */
.header{
  background: linear-gradient(180deg, rgba(11,16,32,0.98), rgba(5,6,10,0.98));
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px;
  display:grid;
  grid-template-columns: 1.2fr 1fr 1fr;
  gap:14px;
}

.headerBlock{
  background:rgba(3,6,12,0.6);
  border:1px solid rgba(120,140,255,0.15);
  border-radius:14px;
  padding:12px;
}

/* === KPI === */
.kpiValue{
  font-size:16px;
  font-weight:900;
}

.kpiSmall{
  font-size:11px;
  color:var(--muted);
}

.kpiYellow{
  font-size:11px;
  color:var(--yellow);
  margin-top:4px;
}

/* === MAIN === */
.main{
  display:grid;
  grid-template-columns: 420px 1fr;
  gap:12px;
  height:100%;
}

.panel{
  background: linear-gradient(180deg, rgba(10,15,28,0.98), rgba(8,10,18,0.98));
  border:1px solid rgba(120,140,255,0.16);
  border-radius:var(--radius);
  padding:12px;
}

/* === CHART === */
.chartBox{
  position:relative;
  height:100%;
}

canvas{
  width:100% !important;
  height:100% !important;
}
</style>
</head>

<body>

<div class="app">

<!-- ================= HEADER ================= -->
<div class="header">

  <!-- KPI -->
  <div class="headerBlock">
    <div class="kpiValue" id="energiaHoy">Energía total consumida HOY: -- kWh</div>
    <div class="kpiYellow" id="energiaExportada">Energía vertida a red: -- kWh</div>
    <div class="kpiSmall" id="energiaRef">Referencia (10 días): -- kWh</div>
    <div class="kpiSmall" id="ultimaAct">Última actualización: --</div>
  </div>

  <!-- DONUT -->
  <div class="headerBlock">
    <canvas id="donutEnergia"></canvas>
  </div>

  <!-- TEMP / FV -->
  <div class="headerBlock" id="headerSensors">
    <!-- Se rellena por JS -->
  </div>

</div>

<!-- ================= MAIN ================= -->
<div class="main">

  <!-- HISTÓRICO -->
  <div class="panel">
    <label>Sensor</label>
    <select id="sensorSelect"></select>

    <label>Fecha inicio</label>
    <input type="date" id="dateStart">

    <label>Fecha final</label>
    <input type="date" id="dateEnd">
  </div>

  <!-- GRÁFICA -->
  <div class="panel">
    <div class="chartBox">
      <canvas id="chart"></canvas>
    </div>
  </div>

</div>

</div>

<script>
/* ================= CONFIG ================= */
const INDEX_URL = "indice_sensores.json";
const DATA_DIR = "datos_sensores";

const WORKER_TRIGGER_URL =
  "https://trigger-dashboard-edificio.tonibravom.workers.dev/";

const HEADER_REFRESH_MS = 5 * 60 * 1000;

/* ================= FETCH ================= */
async function fetchJSON(url){
  const r = await fetch(url + "?t=" + Date.now(), { cache:"no-store" });
  if(!r.ok) throw new Error(r.status);
  return r.json();
}

/* ================= HEADER UPDATE ================= */
async function refreshHeader(){
  const energia = await fetchJSON(`${DATA_DIR}/0190_MV_ENERGIA_CONS.json`);
  const importada = await fetchJSON(`${DATA_DIR}/0190_MV_C1_ASB_ACTIVEE.json`);
  const exportada = await fetchJSON(`${DATA_DIR}/0190_MV_CIA_EXPORT.json`);
  const fv = await fetchJSON(`${DATA_DIR}/0524_MV_FVENERGIA.json`);

  const hoy = energia.values.reduce((a,b)=>a+b,0);
  const imp = importada.values.reduce((a,b)=>a+b,0);
  const prod = fv.values.reduce((a,b)=>a+b,0);
  const exp = exportada.values.reduce((a,b)=>a+b,0);

  document.getElementById("energiaHoy").textContent =
    `Energía total consumida HOY: ${hoy.toFixed(1)} kWh`;

  document.getElementById("energiaExportada").textContent =
    `Energía vertida a red: ${exp.toFixed(1)} kWh`;

  document.getElementById("ultimaAct").textContent =
    "Última actualización: " + new Date().toLocaleString("es-ES");

  drawDonut(imp, prod);
}

/* ================= DONUT ================= */
let donut;
function drawDonut(importada, fv){
  const ctx = document.getElementById("donutEnergia").getContext("2d");
  if(donut) donut.destroy();

  donut = new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Importada","FV"],
      datasets:[{
        data:[importada,fv],
        backgroundColor:["#8b5cf6","#00e676"]
      }]
    },
    options:{
      plugins:{ legend:{ labels:{ color:"#e6eaff" } } }
    }
  });
}

/* ================= AUTO TRIGGER ================= */
async function autoTriggerUpdate(){
  try{
    await fetch(WORKER_TRIGGER_URL,{ method:"POST" });
    setTimeout(refreshHeader, 10000);
  }catch(e){
    console.warn("Trigger error",e);
  }
}

autoTriggerUpdate();
setInterval(autoTriggerUpdate, HEADER_REFRESH_MS);
</script>

</body>
</html>
