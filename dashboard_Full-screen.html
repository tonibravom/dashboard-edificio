<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Edificio Aviny√≥</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.65);
      --accent: #36c6ff;
      --ok: #00d68f;
      --warn: #ffd166;
      --danger: #ff5c7a;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 14px;
      --gap: 14px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 700px at 10% 0%, rgba(54,198,255,0.18), transparent 55%),
                  radial-gradient(900px 500px at 95% 10%, rgba(0,214,143,0.14), transparent 50%),
                  var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    /* Layout full screen sin cortar por barra Windows */
    .app{
      height: 100svh; /* mejor que 100vh en m√≥viles y evita recortes */
      display: grid;
      grid-template-rows: auto 1fr;
      gap: var(--gap);
      padding: 14px;
    }

    .header{
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: var(--gap);
      align-items: stretch;
      min-height: 170px;
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: hidden;
    }

    .title{
      font-size: 14px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 8px 0;
    }

    .kpiRow{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: start;
    }

    .kpiValue{
      font-size: 34px;
      font-weight: 800;
      line-height: 1.05;
    }

    .kpiSub{
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }

    .kpiExport{
      font-size: 12px;
      color: var(--warn);
      margin-top: 6px;
      font-weight: 700;
    }

    .btn{
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: 0.2s ease;
      font-weight: 700;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      height: fit-content;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.09);
    }
    .btn:disabled{
      opacity: 0.55;
      cursor: not-allowed;
      transform: none;
    }

    .statusLine{
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    /* 3 barras debajo del KPI */
    .meters{
      margin-top: 12px;
      display: grid;
      gap: 10px;
    }

    .meter{
      display: grid;
      grid-template-columns: 140px 1fr 70px;
      gap: 10px;
      align-items: center;
    }

    .meterLabel{
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      white-space: nowrap;
    }

    .meterBar{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
    }

    .meterFill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(54,198,255,0.95), rgba(0,214,143,0.95));
      transition: width 0.4s ease;
    }

    .meterPct{
      text-align: right;
      font-size: 12px;
      color: var(--text);
      font-weight: 800;
    }

    /* Donut + leyenda + clima en header */
    .rightHeader{
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 12px;
      align-items: stretch;
    }

    .donutWrap{
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 8px;
      align-items: center;
      justify-items: center;
      padding: 10px;
      border-radius: var(--radius2);
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }

    .donutLegend{
      width: 100%;
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .legendItem{
      display: grid;
      grid-template-columns: 10px 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid rgba(255,255,255,0.25);
    }

    .legendVal{
      color: var(--text);
      font-weight: 800;
      font-size: 12px;
    }

    .climateWrap{
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      overflow: hidden;
    }

    .climateGrid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      min-height: 0;
    }

    .miniCard{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius2);
      padding: 10px;
      overflow: hidden;
    }

    .miniTitle{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      margin-bottom: 8px;
    }

    .plantList{
      display: grid;
      gap: 6px;
      font-size: 12px;
    }

    .plantRow{
      display: grid;
      grid-template-columns: 26px 1fr auto;
      gap: 8px;
      align-items: center;
      color: var(--muted);
    }

    .plantRow b{
      color: var(--text);
      font-weight: 800;
    }

    .emoji{
      font-size: 16px;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.25));
    }

    /* Main area: selector + chart */
    .main{
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: var(--gap);
      min-height: 0; /* importante para que no se corte */
    }

    .leftPanel{
      display: grid;
      grid-template-rows: auto auto 1fr;
      gap: 12px;
      min-height: 0;
    }

    .controlGroup{
      display: grid;
      gap: 10px;
    }

    label{
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    select{
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      font-weight: 700;
      outline: none;
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .chartCard{
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 10px;
      min-height: 0;
    }

    .chartTitleRow{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
    }

    .chartTitle{
      font-size: 16px;
      font-weight: 900;
      margin: 0;
    }

    .chartMeta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .chartArea{
      min-height: 0;
      height: 100%;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius2);
      padding: 10px;
      overflow: hidden;
    }

    canvas{
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 1100px){
      body{ overflow: auto; }
      .app{ height: auto; overflow: auto; }
      .header{ grid-template-columns: 1fr; }
      .main{ grid-template-columns: 1fr; }
      .rightHeader{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- HEADER -->
    <div class="header">

      <!-- KPI principal + 3 barras -->
      <div class="card">
        <div class="title">Energy Monitor</div>

        <div class="kpiRow">
          <div>
            <div class="kpiValue" id="kpiEnergyToday">-- kWh</div>
            <div class="kpiSub" id="kpiRef">Referencia: -- kWh</div>
            <div class="kpiExport" id="kpiExported">Energ√≠a vertida a la red: -- kWh</div>
            <div class="statusLine" id="kpiTime">Actualizado: --</div>

            <!-- 3 barras debajo del KPI -->
            <div class="meters">
              <div class="meter">
                <div class="meterLabel">Climatizaci√≥n</div>
                <div class="meterBar"><div class="meterFill" id="fillClima"></div></div>
                <div class="meterPct" id="pctClima">--%</div>
              </div>

              <div class="meter">
                <div class="meterLabel">Plantas</div>
                <div class="meterBar"><div class="meterFill" id="fillPlantas"></div></div>
                <div class="meterPct" id="pctPlantas">--%</div>
              </div>

              <div class="meter">
                <div class="meterLabel">Otros</div>
                <div class="meterBar"><div class="meterFill" id="fillOtros"></div></div>
                <div class="meterPct" id="pctOtros">--%</div>
              </div>
            </div>
          </div>

          <div style="display:grid; gap:10px; justify-items:end;">
            <button class="btn" id="btnActualizar">
              üîÑ Actualizar datos
            </button>
            <div class="hint" style="max-width:190px; text-align:right;">
              Fuerza la descarga y recarga la p√°gina en 2 minutos.
            </div>
          </div>
        </div>

        <div class="statusLine" id="updateStatus"></div>
      </div>

      <!-- Donut + clima en el hueco del header -->
      <div class="card">
        <div class="title">Building Monitor</div>

        <div class="rightHeader">

          <!-- Donut -->
          <div class="donutWrap">
            <div style="font-size:12px; color:var(--muted); font-weight:900; text-transform:uppercase; letter-spacing:0.5px;">
              Mix consumo HOY
            </div>

            <div style="width: 190px; height: 190px;">
              <canvas id="donutChart"></canvas>
            </div>

            <div class="donutLegend">
              <div class="legendItem">
                <div class="dot" id="dotImport"></div>
                <div>Energ√≠a importada</div>
                <div class="legendVal" id="legImport">-- kWh (--%)</div>
              </div>

              <div class="legendItem">
                <div class="dot" id="dotFV"></div>
                <div>Energ√≠a ISFV</div>
                <div class="legendVal" id="legFV">-- kWh (--%)</div>
              </div>

              <div class="legendItem">
                <div class="dot" style="background: rgba(255,255,255,0.18);"></div>
                <div>Total consumida</div>
                <div class="legendVal" id="legTotal">-- kWh</div>
              </div>
            </div>
          </div>

          <!-- Clima (plantas + FV) -->
          <div class="climateWrap">
            <div class="climateGrid">

              <!-- Plantas -->
              <div class="miniCard">
                <div class="miniTitle">
                  <span class="emoji">üå°Ô∏è</span> Temperatura & Humedad (Plantas)
                </div>
                <div class="plantList" id="plantsTH">
                  <div class="plantRow"><span class="emoji">üè¢</span><span>P1</span><b>-- ¬∞C / -- %</b></div>
                  <div class="plantRow"><span class="emoji">üè¢</span><span>P2</span><b>-- ¬∞C / -- %</b></div>
                  <div class="plantRow"><span class="emoji">üè¢</span><span>P3</span><b>-- ¬∞C / -- %</b></div>
                  <div class="plantRow"><span class="emoji">üè¢</span><span>P4</span><b>-- ¬∞C / -- %</b></div>
                  <div class="plantRow"><span class="emoji">üè¢</span><span>P5</span><b>-- ¬∞C / -- %</b></div>
                </div>
              </div>

              <!-- FV -->
              <div class="miniCard">
                <div class="miniTitle">
                  <span class="emoji">‚òÄÔ∏è</span> ISFV (Exterior)
                </div>
                <div class="plantList" id="fvBox">
                  <div class="plantRow">
                    <span class="emoji">üå°Ô∏è</span>
                    <span>T¬™ exterior</span>
                    <b id="extTemp">-- ¬∞C</b>
                  </div>
                  <div class="plantRow">
                    <span class="emoji">üîÜ</span>
                    <span>Irradiancia</span>
                    <b id="irradiancia">--</b>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- MAIN -->
    <div class="main">

      <!-- Panel izquierdo -->
      <div class="card leftPanel">
        <div>
          <div class="title">Hist√≥ricos</div>
          <div class="hint">
            Selecciona un sensor y un rango. Los datos se cargan desde los JSON generados por GitHub Actions.
          </div>
        </div>

        <div class="controlGroup">
          <div>
            <label for="sensorSelect">Sensor</label>
            <select id="sensorSelect"></select>
          </div>

          <div>
            <label for="rangeSelect">Rango</label>
            <select id="rangeSelect">
              <option value="1d">√öltimas 24h</option>
              <option value="2d" selected>√öltimos 2 d√≠as</option>
              <option value="7d">√öltimos 7 d√≠as</option>
              <option value="30d">√öltimos 30 d√≠as</option>
              <option value="all">Todo</option>
            </select>
          </div>
        </div>

        <div class="hint" id="sensorInfo">
          Cargando √≠ndice de sensores...
        </div>
      </div>

      <!-- Chart -->
      <div class="card chartCard">
        <div class="chartTitleRow">
          <h2 class="chartTitle" id="chartTitle">Serie temporal</h2>
          <div class="chartMeta" id="chartMeta">--</div>
        </div>

        <div class="chartArea">
          <canvas id="lineChart"></canvas>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===============================
    // CONFIG
    // ===============================
    const INDEX_URL = "./indice_sensores.json";
    const DATA_FOLDER = "./datos_sensores/";

    // Worker Cloudflare (trigger workflow)
    const WORKER_TRIGGER_URL = "https://trigger-dashboard-edificio.tonibravom.workers.dev/";

    // IDs sensores clave
    const SENSOR_IMPORTADA = "0190_MV_C1_ASB_ACTIVEE";
    const SENSOR_FV_ENERGIA = "0524_MV_FVENERGIA";
    const SENSOR_TOTAL_CONS = "0190_MV_ENERGIA_CONS";
    const SENSOR_EXPORTADA = "0190_MV_CIA_EXPORT";

    // Climatizaci√≥n
    const SENSORES_CLIMA = [
      "0190_MV_C2_ASB_ACTIVEE",
      "0190_MV_C41_CGEM21_EACTIVA"
    ];

    // Plantas
    const SENSORES_PLANTAS = [
      "0190_MV_C10_CGEM21_EACTIVA",
      "0190_MV_C20_CGEM21_EACTIVA",
      "0190_MV_C30_CGEM21_EACTIVA",
      "0190_MV_C40_CGEM21_EACTIVA",
      "0190_MV_C50_CGEM21_EACTIVA"
    ];

    // Temperatura/Humedad plantas
    const PLANTS = [
      { name: "P1", temp: "0190_HV_S1_STPRO_TEMP", hum: "0190_HV_S1_STPRO_HUM" },
      { name: "P2", temp: "0190_HV_S2_STPRO_TEMP", hum: "0190_HV_S2_STPRO_HUM" },
      { name: "P3", temp: "0190_HV_S3_STPRO_TEMP", hum: "0190_HV_S3_STPRO_HUM" },
      { name: "P4", temp: "0190_HV_S4_STPRO_TEMP", hum: "0190_HV_S4_STPRO_HUM" },
      { name: "P5", temp: "0190_HV_S5_STPRO_TEMP", hum: "0190_HV_S5_STPRO_HUM" },
    ];

    // ISFV exterior
    const SENSOR_TEMP_EXT = "0524_HV_TEMP_EXT";
    const SENSOR_IRRAD = "0524_HV_IRRAD";

    // ===============================
    // HELPERS
    // ===============================
    function fmt(num, decimals = 1){
      if (num === null || num === undefined || Number.isNaN(num)) return "--";
      return Number(num).toLocaleString("es-ES", { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    function parseISODate(s){
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : d;
    }

    function getTodayKey(d){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function sumArray(arr){
      return (arr || []).reduce((a,b)=>a+(Number(b)||0), 0);
    }

    function lastValue(sensorJson){
      if (!sensorJson || !Array.isArray(sensorJson.values) || sensorJson.values.length === 0) return null;
      return Number(sensorJson.values[sensorJson.values.length - 1]);
    }

    function lastLabel(sensorJson){
      if (!sensorJson || !Array.isArray(sensorJson.labels) || sensorJson.labels.length === 0) return null;
      return sensorJson.labels[sensorJson.labels.length - 1];
    }

    function filterByRange(labels, values, range){
      if (!labels || !values || labels.length !== values.length) return {labels:[], values:[]};

      if (range === "all") return {labels, values};

      const now = new Date();
      let cutoff = null;

      if (range === "1d") cutoff = new Date(now.getTime() - 24*3600*1000);
      if (range === "2d") cutoff = new Date(now.getTime() - 48*3600*1000);
      if (range === "7d") cutoff = new Date(now.getTime() - 7*24*3600*1000);
      if (range === "30d") cutoff = new Date(now.getTime() - 30*24*3600*1000);

      const outL = [];
      const outV = [];

      for (let i=0;i<labels.length;i++){
        const d = parseISODate(labels[i]);
        if (!d) continue;
        if (!cutoff || d >= cutoff){
          outL.push(labels[i]);
          outV.push(values[i]);
        }
      }

      return {labels: outL, values: outV};
    }

    async function loadSensorJson(sensorId, index){
      const meta = index?.sensores?.[sensorId];
      if (!meta || !meta.archivo) return null;
      const url = DATA_FOLDER + meta.archivo;
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) return null;
      return await r.json();
    }

    function sumSensorsSameLength(sensorJsons){
      // suma punto a punto asumiendo mismo length; si difiere, usamos el m√≠nimo para asegurar consistencia
      const valid = sensorJsons.filter(x => x && Array.isArray(x.labels) && Array.isArray(x.values));
      if (valid.length === 0) return {labels: [], values: []};

      const minLen = Math.min(...valid.map(x => x.values.length));
      if (minLen <= 0) return {labels: [], values: []};

      const labels = valid[0].labels.slice(-minLen);
      const values = [];

      for (let i=0;i<minLen;i++){
        let s = 0;
        for (const sj of valid){
          const v = Number(sj.values[sj.values.length - minLen + i]);
          s += (isNaN(v) ? 0 : v);
        }
        values.push(s);
      }
      return {labels, values};
    }

    function sumTodayFromSeries(sensorJson){
      if (!sensorJson || !sensorJson.labels || !sensorJson.values) return 0;
      const todayKey = getTodayKey(new Date());
      let sum = 0;

      for (let i=0;i<sensorJson.labels.length;i++){
        const d = parseISODate(sensorJson.labels[i]);
        if (!d) continue;
        if (getTodayKey(d) === todayKey){
          sum += Number(sensorJson.values[i]) || 0;
        }
      }
      return sum;
    }

    // ===============================
    // CHARTS
    // ===============================
    let lineChart = null;
    let donutChart = null;

    function buildLineChart(labels, values, unidad){
      const ctx = document.getElementById("lineChart").getContext("2d");

      if (lineChart) lineChart.destroy();

      lineChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: unidad ? unidad : "Valor",
            data: values,
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${fmt(ctx.parsed.y, 2)} ${unidad || ""}`
              }
            }
          },
          scales: {
            x: {
              ticks: {
                color: "rgba(255,255,255,0.65)",
                maxRotation: 0,
                autoSkip: true,
                maxTicksLimit: 8
              },
              grid: { color: "rgba(255,255,255,0.06)" }
            },
            y: {
              ticks: { color: "rgba(255,255,255,0.65)" },
              grid: { color: "rgba(255,255,255,0.06)" }
            }
          }
        }
      });
    }

    function buildDonut(importada, fv, total){
      const ctx = document.getElementById("donutChart").getContext("2d");
      if (donutChart) donutChart.destroy();

      // colores (los asignamos en runtime sin tocar CSS)
      const cImport = "rgba(54,198,255,0.95)";
      const cFV = "rgba(0,214,143,0.95)";

      document.getElementById("dotImport").style.background = cImport;
      document.getElementById("dotFV").style.background = cFV;

      donutChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Importada", "ISFV"],
          datasets: [{
            data: [importada || 0, fv || 0],
            borderWidth: 0,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: "72%",
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.label}: ${fmt(ctx.parsed, 2)} kWh`
              }
            }
          }
        }
      });

      const pctImport = total > 0 ? (importada / total * 100) : 0;
      const pctFV = total > 0 ? (fv / total * 100) : 0;

      document.getElementById("legImport").textContent = `${fmt(importada,2)} kWh (${fmt(pctImport,1)}%)`;
      document.getElementById("legFV").textContent = `${fmt(fv,2)} kWh (${fmt(pctFV,1)}%)`;
      document.getElementById("legTotal").textContent = `${fmt(total,2)} kWh`;
    }

    function setMeter(idFill, idPct, part, total){
      const pct = total > 0 ? (part/total*100) : 0;
      const clamped = Math.max(0, Math.min(100, pct));
      document.getElementById(idFill).style.width = `${clamped.toFixed(1)}%`;
      document.getElementById(idPct).textContent = `${fmt(clamped,1)}%`;
    }

    // ===============================
    // MAIN LOAD
    // ===============================
    let indexData = null;

    async function init(){
      // cargar √≠ndice
      const r = await fetch(INDEX_URL, { cache: "no-store" });
      indexData = await r.json();

      // llenar select sensores
      const sensorSelect = document.getElementById("sensorSelect");
      sensorSelect.innerHTML = "";

      const sensores = indexData?.sensores || {};
      const ids = Object.keys(sensores).sort((a,b)=>a.localeCompare(b));

      for (const id of ids){
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = `${id} ‚Äî ${sensores[id].descripcion || ""}`;
        sensorSelect.appendChild(opt);
      }

      // default: energ√≠a total consumida si existe
      if (ids.includes(SENSOR_TOTAL_CONS)) sensorSelect.value = SENSOR_TOTAL_CONS;

      sensorSelect.addEventListener("change", renderSelectedSensor);
      document.getElementById("rangeSelect").addEventListener("change", renderSelectedSensor);

      await renderHeaderKPIs();
      await renderSelectedSensor();
    }

    async function renderSelectedSensor(){
      const sensorId = document.getElementById("sensorSelect").value;
      const range = document.getElementById("rangeSelect").value;

      const meta = indexData?.sensores?.[sensorId];
      const info = document.getElementById("sensorInfo");

      info.textContent = meta
        ? `${meta.descripcion || ""} ¬∑ ${meta.unidad || ""} ¬∑ ${meta.tipo_dato || ""}`
        : "Sensor no encontrado en √≠ndice";

      const sj = await loadSensorJson(sensorId, indexData);
      if (!sj){
        document.getElementById("chartTitle").textContent = "Serie temporal";
        document.getElementById("chartMeta").textContent = "Sin datos";
        buildLineChart([], [], "");
        return;
      }

      const {labels, values} = filterByRange(sj.labels, sj.values, range);

      document.getElementById("chartTitle").textContent = `${sj.descripcion || sensorId}`;
      document.getElementById("chartMeta").textContent =
        `${values.length} puntos ¬∑ ${sj.unidad || ""}`;

      buildLineChart(labels, values, sj.unidad || "");
    }

    async function renderHeaderKPIs(){
      // KPI Energ√≠a total consumida HOY (sensor calculado)
      const totalCons = await loadSensorJson(SENSOR_TOTAL_CONS, indexData);
      const importada = await loadSensorJson(SENSOR_IMPORTADA, indexData);
      const fv = await loadSensorJson(SENSOR_FV_ENERGIA, indexData);
      const exportada = await loadSensorJson(SENSOR_EXPORTADA, indexData);

      // fallback si por lo que sea no est√° el sensor calculado
      const totalToday = totalCons ? sumTodayFromSeries(totalCons) : 0;
      const importToday = importada ? sumTodayFromSeries(importada) : 0;
      const fvToday = fv ? sumTodayFromSeries(fv) : 0;
      const exportToday = exportada ? sumTodayFromSeries(exportada) : 0;

      const totalFinal = totalToday > 0 ? totalToday : (importToday + fvToday);

      document.getElementById("kpiEnergyToday").textContent = `${fmt(totalFinal, 2)} kWh`;
      document.getElementById("kpiRef").textContent = `Referencia: ${fmt(totalFinal, 2)} kWh`;
      document.getElementById("kpiExported").textContent = `Energ√≠a vertida a la red: ${fmt(exportToday, 2)} kWh`;

      // hora actualizaci√≥n
      const gen = indexData?.generado ? new Date(indexData.generado) : null;
      document.getElementById("kpiTime").textContent =
        `Actualizado: ${gen ? gen.toLocaleString("es-ES") : "--"}`;

      // Donut: importada + FV = 100% total consumida
      buildDonut(importToday, fvToday, totalFinal);

      // Barras: Climatizaci√≥n / Plantas / Otros respecto total consumida
      const climaJsons = await Promise.all(SENSORES_CLIMA.map(id => loadSensorJson(id, indexData)));
      const plantasJsons = await Promise.all(SENSORES_PLANTAS.map(id => loadSensorJson(id, indexData)));

      const climaSeries = sumSensorsSameLength(climaJsons);
      const plantasSeries = sumSensorsSameLength(plantasJsons);

      const climaToday = sumTodayFromSeries({labels: climaSeries.labels, values: climaSeries.values});
      const plantasToday = sumTodayFromSeries({labels: plantasSeries.labels, values: plantasSeries.values});

      const otrosToday = Math.max(0, totalFinal - climaToday - plantasToday);

      setMeter("fillClima", "pctClima", climaToday, totalFinal);
      setMeter("fillPlantas", "pctPlantas", plantasToday, totalFinal);
      setMeter("fillOtros", "pctOtros", otrosToday, totalFinal);

      // Temperatura/Humedad plantas (√∫ltimo valor)
      const plantsBox = document.getElementById("plantsTH");
      plantsBox.innerHTML = "";

      for (const p of PLANTS){
        const sjT = await loadSensorJson(p.temp, indexData);
        const sjH = await loadSensorJson(p.hum, indexData);

        const t = lastValue(sjT);
        const h = lastValue(sjH);

        const row = document.createElement("div");
        row.className = "plantRow";
        row.innerHTML = `
          <span class="emoji">üè¢</span>
          <span>${p.name}</span>
          <b>${fmt(t,1)} ¬∞C / ${fmt(h,0)} %</b>
        `;
        plantsBox.appendChild(row);
      }

      // FV exterior
      const sjExt = await loadSensorJson(SENSOR_TEMP_EXT, indexData);
      const sjIrr = await loadSensorJson(SENSOR_IRRAD, indexData);

      const extT = lastValue(sjExt);
      const irr = lastValue(sjIrr);

      document.getElementById("extTemp").textContent = `${fmt(extT,1)} ¬∞C`;
      document.getElementById("irradiancia").textContent = `${fmt(irr,0)} W/m¬≤`;
    }

    // ===============================
    // BOT√ìN ACTUALIZAR DATOS
    // ===============================
    const btn = document.getElementById("btnActualizar");
    const updateStatus = document.getElementById("updateStatus");

    btn.addEventListener("click", async () => {
      btn.disabled = true;
      updateStatus.textContent = "‚è≥ Lanzando actualizaci√≥n‚Ä¶";

      try{
        const res = await fetch(WORKER_TRIGGER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "trigger_workflow" })
        });

        if (!res.ok){
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }

        updateStatus.textContent = "‚úÖ Workflow lanzado. Recargando en 2 minutos‚Ä¶";

        // recarga en 2 minutos
        setTimeout(() => {
          location.reload();
        }, 120000);

      }catch(e){
        console.error(e);
        updateStatus.textContent = "‚ùå Error al lanzar workflow. Revisa Worker / token / permisos.";
        btn.disabled = false;
      }
    });

    // init
    init();
  </script>
</body>
</html>
