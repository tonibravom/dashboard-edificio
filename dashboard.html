<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Unreal (Real)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    padding:20px;
  }

  h2{ margin:0 0 12px 0; }

  .topbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:10px;
  }

  select, input{
    padding:6px;
    border-radius:8px;
    border:1px solid #ddd;
  }

  #refreshBtn{
    padding:8px 12px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    background:#2d6cdf;
    color:white;
    font-weight:bold;
  }
  #refreshBtn:disabled{
    opacity:0.6;
    cursor:not-allowed;
  }

  #refreshStatus{
    font-size:14px;
    color:#666;
    min-width: 220px;
  }

  #metrics{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    gap:10px;
    margin:12px 0;
  }

  .metric{
    background:#fff;
    padding:10px;
    border-radius:12px;
    text-align:center;
    box-shadow:0 1px 3px rgba(0,0,0,0.08);
  }

  .metric b{
    display:block;
    font-size:14px;
    margin-bottom:4px;
    color:#333;
  }

  .metric span{
    font-size:18px;
    font-weight:bold;
  }

  .card{
    background:#fff;
    padding:12px;
    padding-bottom:24px; /* âœ… FIX: deja espacio para el eje X */
    border-radius:12px;
    box-shadow:0 1px 3px rgba(0,0,0,0.08);
  }

  .small{
    font-size:13px;
    color:#666;
  }

  canvas{
    width:100%;
    max-width:100%;
  }
</style>
</head>

<body>

<h2>ðŸ“Š Dashboard Unreal (datos reales)</h2>

<div class="topbar">
  <label>
    Sensor:
    <select id="sensorSelect"></select>
  </label>

  <label>
    Desde:
    <input type="date" id="dateStart">
  </label>

  <label>
    Hasta:
    <input type="date" id="dateEnd">
  </label>

  <label>
    ResoluciÃ³n:
    <select id="resolutionSelect">
      <option value="15m">15m</option>
      <option value="1h">1h</option>
      <option value="1d">1d</option>
    </select>
  </label>

  <button id="refreshBtn">ðŸ”„ Actualizar</button>
  <span id="refreshStatus"></span>
</div>

<div class="card">
  <div id="sensorInfo" class="small">Cargando...</div>
</div>

<div id="metrics"></div>

<div class="card">
  <canvas id="chart" height="120"></canvas>
</div>

<script>
/* =========================================================
   CONFIG
========================================================= */
const DATA_FOLDER = "datos_sensores";            // carpeta real
const INDEX_FILE  = "indice_sensores.json";      // Ã­ndice real
const AUTO_REFRESH_SECONDS = 60;                 // autorefresco (cambia aquÃ­)

/* =========================================================
   STATE
========================================================= */
let chart = null;
let currentSensorData = null;
let currentSensorMeta = null;
let sensorIndex = null;
let refreshTimer = null;

/* =========================================================
   HELPERS
========================================================= */
function toISODateLocal(d){
  const year = d.getFullYear();
  const month = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${year}-${month}-${day}`;
}

function parseTS(ts){
  // timestamps: "2026-01-27T07:30:02"
  return new Date(ts);
}

function formatNumber(v){
  if (v === null || v === undefined || Number.isNaN(v)) return "-";
  return (Math.round(v * 1000) / 1000).toString();
}

function setDefaultLast2Days(){
  const now = new Date();
  const end = toISODateLocal(now);
  const start = new Date(now.getTime() - 1 * 86400000);

  document.getElementById("dateStart").value = toISODateLocal(start);
  document.getElementById("dateEnd").value = end;
}

/* =========================================================
   LOADERS (REAL)
========================================================= */
async function loadIndex(){
  const res = await fetch(`${INDEX_FILE}?t=${Date.now()}`, { cache:"no-store" });
  if(!res.ok) throw new Error("No se pudo cargar " + INDEX_FILE);
  return await res.json();
}

async function loadSensorFile(fileName){
  const url = `${DATA_FOLDER}/${fileName}?t=${Date.now()}`;
  const res = await fetch(url, { cache:"no-store" });
  if(!res.ok) throw new Error("No se pudo cargar " + url);
  return await res.json();
}

/* =========================================================
   FILTERING + RESOLUTION
========================================================= */
function filterByDate(labels, values, startDateStr, endDateStr){
  if(!labels || !values) return {labels:[], values:[]};

  const start = new Date(startDateStr + "T00:00:00");
  const end = new Date(endDateStr + "T23:59:59");

  const outL = [];
  const outV = [];

  for(let i=0;i<labels.length;i++){
    const t = parseTS(labels[i]);
    if(t >= start && t <= end){
      outL.push(labels[i]);
      outV.push(values[i]);
    }
  }

  return { labels: outL, values: outV };
}

function aggregate(labels, values, mode){
  // mode: 15m (sin cambios), 1h (promedio), 1d (promedio)
  if(mode === "15m"){
    return { labels, values };
  }

  const bucketMs = (mode === "1h") ? 3600000 : 86400000;

  const buckets = new Map();

  for(let i=0;i<labels.length;i++){
    const t = parseTS(labels[i]).getTime();
    const b = Math.floor(t / bucketMs) * bucketMs;

    if(!buckets.has(b)) buckets.set(b, []);
    buckets.get(b).push(values[i]);
  }

  const outLabels = [];
  const outValues = [];

  Array.from(buckets.keys()).sort((a,b)=>a-b).forEach(k=>{
    const arr = buckets.get(k);
    const avg = arr.reduce((s,x)=>s+x,0) / arr.length;
    outLabels.push(new Date(k).toISOString().slice(0,19)); // "YYYY-MM-DDTHH:MM:SS"
    outValues.push(avg);
  });

  return { labels: outLabels, values: outValues };
}

/* =========================================================
   ENERGY HELPERS
========================================================= */
function sumToday(labels, values){
  // suma desde las 00:00 del dÃ­a de la Ãºltima lectura disponible
  if(!labels || labels.length === 0) return 0;

  const last = parseTS(labels[labels.length - 1]);
  const midnight = new Date(last);
  midnight.setHours(0,0,0,0);

  let total = 0;

  for(let i=0;i<labels.length;i++){
    const t = parseTS(labels[i]);
    if(t >= midnight){
      total += values[i];
    }
  }

  return total;
}

/* =========================================================
   METRICS
========================================================= */
function computeMetrics(values){
  if(!values || values.length === 0){
    return { current:null, min:null, max:null, avg:null, sum:null };
  }

  const current = values[values.length-1];
  let min = values[0];
  let max = values[0];
  let sum = 0;

  values.forEach(v=>{
    if(v < min) min = v;
    if(v > max) max = v;
    sum += v;
  });

  const avg = sum / values.length;
  return { current, min, max, avg, sum };
}

function renderMetrics(m, unidad, tipoDato){
  const metricsDiv = document.getElementById("metrics");
  metricsDiv.innerHTML = "";

  // âœ… Para energÃ­a: "Actual" se renombra a "Hoy"
  const labelActual = (tipoDato === "consumo_intervalo") ? "Hoy" : "Actual";

  const items = [
    { label: labelActual, value: m.current },
    { label:"MÃ­n", value: m.min },
    { label:"MÃ¡x", value: m.max },
    { label:"Media", value: m.avg },
    { label:"Suma", value: m.sum },
  ];

  items.forEach(it=>{
    const div = document.createElement("div");
    div.className = "metric";
    div.innerHTML = `<b>${it.label}</b><span>${formatNumber(it.value)} ${unidad || ""}</span>`;
    metricsDiv.appendChild(div);
  });
}

/* =========================================================
   CHART
========================================================= */
function drawChart(labels, values, title){
  const ctx = document.getElementById("chart").getContext("2d");

  if(chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels.map(x => x.replace("T"," ")),
      datasets: [{
        label: title,
        data: values,
        borderWidth: 2,
        tension: 0.25,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      animation: false,
      plugins: {
        legend: { display: true }
      },
      layout: {
        padding: { bottom: 10 } // âœ… ayuda extra al eje X
      },
      scales: {
        x: { ticks: { maxTicksLimit: 8 } },
        y: { beginAtZero: false }
      }
    }
  });
}

/* =========================================================
   REDRAW
========================================================= */
function redraw(){
  if(!currentSensorData) return;

  const start = document.getElementById("dateStart").value;
  const end   = document.getElementById("dateEnd").value;
  const resMode = document.getElementById("resolutionSelect").value;

  const filtered = filterByDate(
    currentSensorData.labels,
    currentSensorData.values,
    start, end
  );

  const agg = aggregate(filtered.labels, filtered.values, resMode);

  const unidad = currentSensorMeta?.unidad || currentSensorData.unidad || "";
  const title  = currentSensorMeta?.descripcion || currentSensorData.descripcion || currentSensorData.sensor_id;
  const tipoDato = currentSensorMeta?.tipo_dato || currentSensorData.tipo_dato;

  let m = computeMetrics(agg.values);

  // âœ… FIX CLAVE:
  // Para energÃ­a (kWh por intervalo): el campo "Hoy" debe ser la suma desde 00:00
  if(tipoDato === "consumo_intervalo"){
    m.current = sumToday(agg.labels, agg.values);
  }

  renderMetrics(m, unidad, tipoDato);
  drawChart(agg.labels, agg.values, title);

  // Info arriba
  const info = document.getElementById("sensorInfo");
  info.textContent =
    `Sensor: ${currentSensorData.sensor_id} | ${title} | Unidad: ${unidad} | Tipo: ${tipoDato}`;
}

/* =========================================================
   REFRESH BUTTON + AUTOREFRESH
========================================================= */
async function refreshCurrentSensor(){
  const btn = document.getElementById("refreshBtn");
  const status = document.getElementById("refreshStatus");
  const sensorId = document.getElementById("sensorSelect").value;

  try{
    btn.disabled = true;
    status.textContent = "Actualizando...";

    const meta = sensorIndex.sensores[sensorId];
    if(!meta) throw new Error("Sensor no encontrado en Ã­ndice: " + sensorId);

    currentSensorMeta = meta;
    currentSensorData = await loadSensorFile(meta.archivo);

    redraw();

    status.textContent = `âœ… Actualizado ${new Date().toLocaleTimeString()} (auto ${AUTO_REFRESH_SECONDS}s)`;
  }catch(err){
    console.error(err);
    status.textContent = "âŒ Error al actualizar";
  }finally{
    btn.disabled = false;
  }
}

function startAutoRefresh(){
  if(refreshTimer) clearInterval(refreshTimer);

  refreshTimer = setInterval(() => {
    refreshCurrentSensor();
  }, AUTO_REFRESH_SECONDS * 1000);
}

/* =========================================================
   INIT
========================================================= */
async function init(){
  const select = document.getElementById("sensorSelect");

  sensorIndex = await loadIndex();

  // Dropdown con descripciÃ³n + unidad + id
  const ids = Object.keys(sensorIndex.sensores);
  ids.sort();

  select.innerHTML = "";
  ids.forEach(id=>{
    const meta = sensorIndex.sensores[id];
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${meta.descripcion} (${id}) [${meta.unidad}]`;
    select.appendChild(opt);
  });

  setDefaultLast2Days();

  // Eventos
  select.onchange = refreshCurrentSensor;
  document.getElementById("dateStart").onchange = redraw;
  document.getElementById("dateEnd").onchange = redraw;
  document.getElementById("resolutionSelect").onchange = redraw;

  document.getElementById("refreshBtn").onclick = refreshCurrentSensor;

  // Cargar el primero
  await refreshCurrentSensor();

  // Auto refresh
  startAutoRefresh();

  document.getElementById("refreshStatus").textContent =
    `â± Autorefresco cada ${AUTO_REFRESH_SECONDS}s`;
}

init().catch(err=>{
  console.error(err);
  alert("Error cargando dashboard. Revisa indice_sensores.json y la carpeta datos_sensores/");
});
</script>

</body>
</html>
